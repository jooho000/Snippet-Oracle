{% extends "layout.html" %}
{% block title %}{{ snippet["name"] }} - Snippet Oracle{% endblock %}
{% block content %}
  <section class="section">
    <div class="columns is-mobile">
      <div class="column is-narrow">
        <h1 class="title">{{ snippet["name"] }}</h1>
        <!-- Snippet Name -->
      </div>
      <div class="column is-narrow has-text-right">
        <!-- Visibility Status (Lock for private, Globe for public) -->
        {% if snippet["is_public"] %}
          <span class="icon is-small">
            <i class="fas fa-globe"></i> <!-- Globe icon for public -->
          </span>
          <span>Public</span>
        {% else %}
          <span class="icon is-small">
            <i class="fas fa-lock"></i> <!-- Lock icon for private -->
          </span>
          <span>Private</span>
        {% endif %}
      </div>
    </div>
    <!-- Snippet Content -->
    <pre><code id="snippet-code">{{ snippet["code"] }}</code></pre><!-- Snippet Code -->
    <p>
      <strong>Description:</strong> {{ snippet["description"] }}
    </p>
    <!-- Snippet Description -->
    <p>
      <strong>Created at:</strong> {{ snippet["date"] }}
    </p>
    <!-- Snippet Date -->
    <!-- Copy to Clipboard Button -->
    <div class="field">
      <div class="control">
        <button class="button is-link" id="copyButton">Copy Code</button>
        {% set id = current_user.id | int %}
        {% if snippet["user_id"] == id %}
          <a class="button is-link"
             href="{{ url_for('edit_snippet', snippet_id=snippet["id"]) }}">
            <span class="icon">
              <i class="fas fa-edit"></i>
            </span>
          </a>
          <a class="button is-link"
             href="{{ url_for('delete_Snippet', snippet_id=snippet["id"]) }}">
            <span class="icon">
              <i class="fas fa-trash"></i>
            </span>
          </a>
        {% endif %}
      </div>
    </div>
    <!-- Shareable Link -->
    {% if not request.path.startswith('/share/') %}
      <div class="box">
        <p>
          <strong>Shareable Link:</strong>
        </p>
        <div class="field has-addons">
          <div class="control is-expanded">
            <input class="input"
                   type="text"
                   id="shareableLink"
                   value="{{ request.host_url }}share/{{ snippet['shareable_link'] }}"
                   readonly>
          </div>
          <div class="control">
            <button class="button is-info" id="copyShareLink">Copy Link</button>
          </div>
        </div>
      </div>
    {% endif %}

<!-- Comment Section -->
<div class="box">
  <h2 class="title is-4">Comments</h2>

  <!-- Display Existing Comments -->
  <div id="comments-section">
    {% for comment in comments %}
    <article class="media box has-background-dark has-text-white mb-4">
      <figure class="media-left">
        <p class="image is-64x64">
          <img class = is-rounded src="{{ url_for('static', filename='profile_pictures/' + (comment['profile_picture'] 
          if comment['profile_picture'] else 'default_image.png')) }}" alt="Profile Picture">
        </p>   
      </figure>
      <div class="media-content">
        <div class="content">
          <strong>{{ comment["user_name"] }}</strong>
          <small class="has-text-grey-light timestamp" data-timestamp="{{ comment['date'] }}">{{ comment["date"] }}</small>
          <p>{{ comment["content"] }}</p>
        </div>

    
        <!-- Comment Actions -->
        <nav class="level is-mobile">
          <div class="level-left">
            <button class="button is-small is-link" onclick="toggleReplyForm({{ comment['id'] }})">
              Reply
            </button>
            {% if comment["user_id"] == current_user.id | int or snippet["user_id"] == current_user.id | int %}
              <form action="{{ url_for('delete_comment', comment_id=comment['id']) }}" method="post" class="is-inline">
                <button class="button is-small is-danger" type="submit">Delete</button>
              </form>
            {% endif %}
          </div>
        </nav>
    
        <!-- Reply Form -->
        <div id="reply-form-{{ comment['id'] }}" class="reply-form is-hidden">
          <form action="{{ url_for('add_comment', snippet_id=snippet['id']) }}" method="post">
            <input type="hidden" name="parent_id" value="{{ comment['id'] }}">
            <textarea class="textarea" name="comment" placeholder="Write a reply..." required></textarea>
            <button type="submit" class="button is-link is-small">Post Reply</button>
          </form>
        </div>
    
        <!-- Nested Replies -->
        {% if comment["replies"] %}
            {% for reply in comment["replies"] %}
            <article class="media">
              <figure class="media-left">
                <p class="image is-64x64">
                  <img class = is-rounded
                  src="{{ url_for('static', filename='profile_pictures/' + (reply['profile_picture'] 
                  if reply['profile_picture'] else 'default_image.png')) }}" alt="Profile Picture">
                </p>                
              </figure>
              <div class="media-content">
                <div class="content">
                  <strong>{{ reply["user_name"] }}</strong>
                  <small class="has-text-grey-light timestamp" data-timestamp="{{ comment['date'] }}">{{ comment["date"] }}</small>
                  <p>{{ reply["content"] }}</p>
                </div>
    
                <!-- Reply Actions -->
                 <nav class="level is-mobile">
                  <div class="level-left">

                    {% if reply["user_id"] == current_user.id | int or snippet["user_id"] == current_user.id | int %}
                      <form action="{{ url_for('delete_comment', comment_id=reply['id']) }}" method="post" class="is-inline">
                        <button class="button is-small is-danger" type="submit">Delete</button>
                      </form>
                    {% endif %}
                  </div>
                </nav>
    
                <!-- Reply Form for Nested Replies -->
                <div id="reply-form-{{ reply['id'] }}" class="is-hidden">
                  <form action="{{ url_for('add_comment', snippet_id=snippet['id']) }}" method="post">
                    <input type="hidden" name="parent_id" value="{{ reply['id'] }}">
                    <textarea class="textarea is-small" name="comment" placeholder="Write a reply..." required></textarea>
                    <button type="submit" class="button is-link is-small">Post Reply</button>
                  </form>
                </div>
              </div>
            </article>
            {% endfor %}
        {% endif %}
      </div>
    </article>
    {% else %}
    <p>No comments yet. Be the first to comment!</p>
    {% endfor %}
  </div>

  <!-- Add New Comment -->
  <article class="media">
    <figure class="media-left">
    </figure>
    <div class="media-content">
      <form action="{{ url_for('add_comment', snippet_id=snippet['id']) }}" method="post">
        <div class="field">
          <p class="control">
            <textarea class="textarea" name="comment" placeholder="Write your comment here..." required></textarea>
          </p>
        </div>
        <div class="field">
          <p class="control">
            <button class="button is-link">Post Comment</button>
          </p>
        </div>
      </form>
    </div>
  </article>
</div>

    <!-- Message for users viewing a shared snippet -->
    {% if request.path.startswith('/share/') %}
      <div class="notification is-info">
        <p>You are viewing this snippet from a shareable link.</p>
        <a href="{{ url_for("index") }}" class="button is-primary">Go to Homepage</a>
      </div>
    {% endif %}
    <!-- Buttons for navigation -->
    <div class="field is-grouped">
      <div class="control">
        <a class="button is-light" href="{{ url_for("snippets") }}">Back to All Snippets</a>
      </div>
      <div class="control">
        <a class="button is-light" href="{{ url_for("createSnippet") }}">Create New Snippet</a>
      </div>
    </div>
  </section>
{% endblock %}
{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='copy.js') }}"></script>
  <script>
  document.getElementById("copyShareLink")?.addEventListener("click", function() {
      const input = document.getElementById("shareableLink");
      input.select();
      document.execCommand("copy");
      alert("Shareable link copied!");
  });
  </script>

<script>
  function toggleReplyForm(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    if (replyForm) {
      replyForm.classList.toggle('is-hidden');
    }
  }
</script>

<script>
  function parseDate(dateString) {
      // Convert "YYYY-MM-DD HH:mm:ss" to "YYYY-MM-DDTHH:mm:ssZ" (ISO format)
      let dateParts = dateString.split(" ");
      let formattedDate = dateParts[0] + "T" + dateParts[1] + "Z"; // Append 'Z' for UTC

      return new Date(formattedDate);
  }

  function timeAgo(dateString) {
      const now = new Date();
      const pastDate = parseDate(dateString);

      if (isNaN(pastDate)) {
          console.error("Invalid Date:", dateString);
          return "Unknown time";
      }

      const seconds = Math.floor((now - pastDate) / 1000);
      const intervals = {
          year: 31536000,
          month: 2592000,
          week: 604800,
          day: 86400,
          hour: 3600,
          minute: 60,
          second: 1
      };

      for (const [unit, value] of Object.entries(intervals)) {
          const count = Math.floor(seconds / value);
          if (count >= 1) {
              return new Intl.RelativeTimeFormat("en", { numeric: "auto" }).format(-count, unit);
          }
      }
      return "just now";
  }

  document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".timestamp").forEach(function (element) {
          let timestamp = element.dataset.timestamp;
          element.textContent = timeAgo(timestamp);
      });
  });
</script>

{% endblock %}
