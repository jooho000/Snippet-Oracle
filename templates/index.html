{% extends "layout.html" %}

{% block title %}Welcome - Snippet Oracle{% endblock %}

{% block content %}
<section class="section">
    <div class="container has-text-centered">
        <h1 class="title">Welcome to Snippet Oracle</h1>
        <p class="subtitle">Effortlessly manage, search, and share your code snippets.</p>

        <!-- Buttons for Navigation -->
        <div class="buttons is-centered mt-5">
            <a class="button is-primary is-large" href="{{ url_for('createSnippet') }}">Create Snippet</a>
            <a class="button is-link is-large" href="{{ url_for('snippets') }}">View My Snippets</a>
        </div>

        <!-- Search Bar -->
        <div class="field mt-5">
            <div class="control has-icons-left has-icons-right">
                <input
                    class="input is-large"
                    id="search-input"
                    type="text"
                    placeholder="Search for snippets...(name | -desc | :tag)"
                />
                <span class="icon is-small is-left">
                    <i class="fas fa-search"></i>
                </span>
            </div>
        </div>

        <!-- Search Results Display -->
        <div id="search-results" class="mt-5"></div>
    </div>

    <div class="snippets-container">
        {% if snippets %}
            {% for snippet in snippets %}
                <div class="box">
                    <!-- Snippet Header Row -->
                    <div class="columns is-vcentered is-mobile">
                        <!-- Name (left side) -->
                        <div class="column is-one-third has-text-left">
                            <strong class="has-text-primary">{{ snippet[1] }}</strong>
                        </div>
                        
                        <!-- Description (center, summarized) -->
                        <div class="column is-one-third has-text-centered">
                            <span>{{ snippet[3] or "No description available." }}</span>
                        </div>
                        
                        <!-- Dropdown Toggle and Copy Button (right side) -->
                        <div class="column is-one-third has-text-right">
                            <!-- Dropdown Toggle Button -->
                            <button 
                                class="button is-small is-primary" 
                                onclick="toggleSnippet('snippet-{{ loop.index }}', this)"
                            >
                                <span class="icon">
                                    <svg id="arrow-icon-{{ loop.index }}" xmlns="http://www.w3.org/2000/svg" class="hero-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </span>
                            </button>

                            <!-- Copy Button -->
                            <button 
                                class="button is-small is-link ml-2" 
                                onclick="copySnippet('{{ snippet[2] }}')"
                            >
                                <span class="icon">
                                    <i class="fas fa-copy"></i>
                                </span>
                                <span>Copy</span>
                            </button>
                        </div>
                    </div>
    
                    <!-- Hidden Content (Code Snippet & Full Description) -->
                    <div id="snippet-{{ loop.index }}" class="is-hidden mt-3">
                        <hr>
                        <pre class="code-snippet">{{ snippet[2] }}</pre>
                        <p><strong>Description:</strong> {{ snippet[3] or "No description available." }}</p>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>No snippets found. Create one!</p>
        {% endif %}
    </div>

</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Function to copy the code snippet
    function copySnippet(code) {
        navigator.clipboard.writeText(code).then(() => {
            alert("Code snippet copied to clipboard!");
        }).catch(err => {
            console.error("Failed to copy text: ", err);
        });
    }
</script>

<script>
    // Function to toggle the visibility of snippet content and the arrow direction
    function toggleSnippet(id, button) {
        const element = document.getElementById(id);
        const icon = button.querySelector("i");
        
        if (element.classList.contains("is-hidden")) {
            element.classList.remove("is-hidden"); // Show the content
            icon.classList.remove("fa-chevron-down"); // Change to up arrow
            icon.classList.add("fa-chevron-up");
        } else {
            element.classList.add("is-hidden"); // Hide the content
            icon.classList.remove("fa-chevron-up"); // Change to down arrow
            icon.classList.add("fa-chevron-down");
        }
    }
</script>

<script>
// JavaScript for handling search and displaying results as buttons
const searchInput = document.getElementById('search-input');
const resultsContainer = document.getElementById('search-results');

searchInput.addEventListener('input', function () {
    const query = searchInput.value;

    // Don't search if input is empty
    if (!query.trim()) {
        resultsContainer.innerHTML = '';
        return;
    }

    // Send the query to the server via AJAX (using fetch)
    fetch(`/search?q=${query}`)
        .then(response => response.json())
        .then(data => {
            resultsContainer.innerHTML = '';  // Clear previous results

            // If there are results, display them as buttons
            if (data.results.length > 0) {
                data.results.forEach(snippet => {
                    const button = document.createElement('a');
                    button.href = `/snippet/${snippet.id}`;
                    button.className = 'button is-primary is-large mt-2';
                    button.textContent = snippet.name;
                    resultsContainer.appendChild(button);
                });
            } else {
                resultsContainer.innerHTML = 'No snippets found.';
            }
        })
        .catch(error => {
            console.error('Error fetching search results:', error);
            resultsContainer.innerHTML = 'Error occurred while searching.';
        });
});
</script>
{% endblock %}
